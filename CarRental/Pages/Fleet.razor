@page "/fleet"
@using CarRentalLogic.Classes;
@using CarRentalCommon.Classes
@using CarRentalCommon.Interfaces;
@using CarRentalCommon.Enums;
@using System.Linq;
@using System.Text.RegularExpressions;
@inject Services services

<PageTitle>Fleet</PageTitle>
<Alert Message="@errorMessage" OnClose="CloseAlert" />

<div class="container-fluid p-5">
    <div class="row mb-5">
        <h3 class="text-center mb-0"><img src="images/logo-white.png" class="w-25" /></h3>
        <h2 class="text-center text-muted fst-italic fw-light">A Collection of Classics</h2>
    </div>
    <div class="row">
        <!-- Vehicle Information Column -->
        <div class="col-3">
            <table class="table table-borderless mt-5">
                <tbody>
                    <tr>
                        <td colspan="2" class="fw-bold border-bottom h4">Vehicle Details</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Reg. No:</td>
                        <td class="col-9">@currentVehicle.RegNo</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Type:</td>
                        <td class="col-9">@currentVehicle.VehicleType</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Make:</td>
                        <td class="col-9">@currentVehicle.Make</td>
                    </tr>
                    <tr>
                        <td colspan="2" class="fw-bold border-bottom h4">Rental Information</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Odometer:</td>
                        <td class="col-9">@currentVehicle.Odometer km</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">
                                @if (currentVehicle is ICar car)
                                {
                                <span>Doors</span>
                                }
                                else if (currentVehicle is IMotorcycle mc)
                                {
                                <span>Seats</span>
                                }
                        </td>
                        <td class="col-9">
                                @if (currentVehicle is ICar cars)
                                {
                                    @cars.Doors.ToString()
                                }
                                else if (currentVehicle is IMotorcycle mcs)
                                {
                                    @mcs.Seats.ToString()
                                }
                        </td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Cost/km:</td>
                        <td class="col-9">@currentVehicle.CostKm €</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Cost/day:</td>
                        <td class="col-9">@currentVehicle.CostDay €</td>
                    </tr>
                    <tr>
                        <td class="col-3 fw-bold">Status:</td>
                        <td class="col-9">
                            <span class="@((services.BookingStatus(currentVehicle.RegNo) == VehicleStatus.Available) ? "bi-circle-fill text-success" : "bi-circle-fill text-danger")">
                            </span>
                            <span class="font-monospace text-uppercase"> @(services.BookingStatus(currentVehicle.RegNo) == VehicleStatus.Available ? " Available" : " Booked")
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            
                        </td>
                    </tr>

                </tbody>
            </table>
        </div>


        <!-- Vehicle Image Column -->
        <div class="col-6 text-center">
            <img src="@($"/images/vehicles/{currentVehicle.RegNo}.png")" alt="Image of @currentVehicle.RegNo" class="img-fluid w-100 mt-5" />
            <h3 class="fw-bold">@currentVehicle.Make</h3>
            <h6 class="text-muted font-monospace">@currentVehicle.Year</h6>
        </div>

        <!-- Vehicle Selection Column -->
        <div class="col-3">
            <h4 class="fw-bold mt-5 border-bottom">Select a Model</h4>
            <div class="font-monospace">
                @foreach (var vehicle in vehicles)
                {
                    <button type="button"
                            class="btn btn-sm @(vehicle.RegNo == currentVehicle.RegNo ? "btn-dark" : "btn-outline-secondary border-0") d-flex align-items-center w-100 p-2 my-1"
                    @onclick="() => SetCurrentVehicle(vehicle)">
                        <span class="@((services.BookingStatus(vehicle.RegNo) == VehicleStatus.Available) ? "bi-circle-fill text-success" : "bi-circle-fill text-danger") me-2">
                        </span>
                        @vehicle.Make
                    </button>
                }
            </div>
            <h4 class="fw-bold mt-3 border-bottom">Book Now</h4>
            <div class="font-monospace">
                <div class="">
                    @if (services.BookingStatus(currentVehicle.RegNo) == VehicleStatus.Available)
                    {
                        <select @bind="selectedCustomer" disabled="@isProcessing" class="drop-down">
                            <option value="">Choose Customer</option>
                            @foreach (var customer in customers)
                            {
                                <option value="@customer.SSN">@($"{customer.FirstName} {customer.LastName}")</option>
                            }
                        </select>
                        <button @onclick="() => RentVehicleAsync(currentVehicle)" class="ms-3 btn btn-sm btn-secondary" disabled="@(isProcessing || string.IsNullOrEmpty(selectedCustomer))">Rent</button>
                    }
                    else
                    {
                        var bookedCustomer = bookings.FirstOrDefault(b => b.Vehicle.RegNo == currentVehicle.RegNo && b.Status == VehicleStatus.Booked)?.Customer;
                        if (bookedCustomer != null)
                        {
                            <p><strong>Booked by:</strong> @($"{bookedCustomer.FirstName} {bookedCustomer.LastName}")</p>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid p-5 pt-3">
    <div class="row">
        <div class="col">
            <h3>Bookings</h3>
            <table class="table table-borderless text-nowrap">
                <thead>
                    <tr>
                        <th style="width: 10%;">Reg. No.</th>
                        <th style="width: 10%;">Customer</th>
                        <th style="width: 10%;">Odometer</th>
                        <th style="width: 10%;">Driven (km)</th>
                        <th style="width: 10%;">Rented (date)</th>
                        <th style="width: 10%;">Returned (date)</th>
                        <th style="width: 5%;">Total</th>
                        <th style="width: 35%;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (IBooking b in bookings)
                    {
                        <tr>
                            <td>@b.Vehicle.RegNo</td>
                            <td>@b.Customer.FirstName @b.Customer.LastName</td>
                            <td>@b.Vehicle.Odometer km</td>
                            <td><input @bind-value="b.KmDriven" @bind-value:event="oninput" placeholder="Enter value upon return" disabled="@(b.Status == VehicleStatus.Available)" /></td>
                            <td><input type="date" @bind="b.RentDate" class="w-100" disabled="@(b.Status == VehicleStatus.Available)" /></td>
                            <td><input type="date" @bind="b.ReturnDate" placeholder="yyyy-MM-dd" class="w-100" disabled="@(b.Status == VehicleStatus.Available)" /></td>
                            <td>@services.TotalCost(b) €</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    @if (b.Status == VehicleStatus.Available)
                                    {
                                        <span class="badge bg-success fs-6 text-uppercase">Returned</span>
                                    }
                                    else if (b.Status == VehicleStatus.Booked)
                                    {
                                        <span class="badge bg-warning fs-6 text-uppercase">On-going</span>
                                        <button @onclick="() => ReturnVehicle(b)" class="ms-3 btn btn-sm btn-secondary">Return</button>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {

    private IVehicle currentVehicle;

    private string errorMessage = string.Empty;
    private bool showInstructions = false;
    private bool isProcessing = false;
    private List<IBooking> bookings = new();
    private List<IPerson> customers = new();
    private List<IVehicle> vehicles = new();
    private IPerson newCustomer = new Customer();
    private IVehicle newCar = new Car();
    private IVehicle newMC = new Motorcycle();
    private string typeOfVehicle = string.Empty;
    private string selectedCustomer = string.Empty;

    protected override void OnInitialized()
    {
        bookings = services.Get<IBooking>().ToList();
        customers = services.Get<IPerson>().ToList();
        vehicles = services.Get<IVehicle>().ToList();
        currentVehicle = vehicles.FirstOrDefault();

    }

    private void SetCurrentVehicle(IVehicle vehicle)
    {
        currentVehicle = vehicle;
    }

    private void ToggleInstructions() => showInstructions = !showInstructions;

    private void ErrorMessage(string info) => errorMessage = $"{info}";

    private void CloseAlert() => errorMessage = string.Empty;

    private void AddNewVehicle()
    {
        try
        {
            if (typeOfVehicle == "Car" && !Regex.IsMatch(newCar.RegNo, @"^[A-Z]{3}\d{3}$"))
            {
                ErrorMessage("[REG. NO.] - Accepted format: 'ABC123'");
                return;
            }
            if (typeOfVehicle == "Car" && string.IsNullOrEmpty(newCar.Make))
            {
                ErrorMessage("[MAKE] - Missing input");
                return;
            }
            if (typeOfVehicle == "Car" && (newCar.Odometer < 0 || newCar.Odometer == null))
            {
                ErrorMessage("[ODOMETER] - Accepted format: Integer");
                return;
            }
            if (typeOfVehicle == "Car" && newCar is ICar car && (car.Doors < 0 || car.Doors == null))
            {
                ErrorMessage("[NO. OF DOORS] - Accepted format: Integer");
                return;
            }
            if (typeOfVehicle == "Car" && (newCar.CostKm < 0 || newCar.CostKm == null))
            {
                ErrorMessage("[COST/KM] - Accepted format: Decimal");
                return;
            }
            if (typeOfVehicle == "Motorcycle" && !Regex.IsMatch(newMC.RegNo, @"^[A-Z]{3}\d{3}$"))
            {
                ErrorMessage("[REG. NO.] - Accepted format: 'ABC123'");
                return;
            }
            if (typeOfVehicle == "Motorcycle" && string.IsNullOrEmpty(newMC.Make))
            {
                ErrorMessage("[MAKE] - Missing input");
                return;
            }
            if (typeOfVehicle == "Motorcycle" && (newMC.Odometer < 0 || newMC.Odometer == null))
            {
                ErrorMessage("[ODOMETER] - Accepted format: Integer");
                return;
            }
            if (typeOfVehicle == "Motorcycle" && newMC is IMotorcycle mc && (mc.Seats < 0 || mc.Seats == null))
            {
                ErrorMessage("[NO. OF SEATS] - Accepted format: Integer");
                return;
            }
            if (typeOfVehicle == "Motorcycle" && (newMC.CostKm < 0 || newMC.CostKm == null))
            {
                ErrorMessage("[COST/KM] - Accepted format: Decimal");
                return;
            }

            if (typeOfVehicle == "Car")
            {
                services.Add(newCar);
                newCar = new Car();
            }
            else if (typeOfVehicle == "Motorcycle")
            {
                services.Add(newMC);
                newMC = new Motorcycle();
            }

            vehicles = services.Get<IVehicle>().ToList();
            errorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private void AddNewCustomer()
    {
        try
        {
            if (string.IsNullOrEmpty(newCustomer.SSN) || !Regex.IsMatch(newCustomer.SSN, @"^\d{6}-\d{4}$"))
            {
                ErrorMessage("[SOCIAL SEC. NO.] Accepted format: '012345-6789'");
                return;
            }
            if (string.IsNullOrEmpty(newCustomer.FirstName) || !Regex.IsMatch(newCustomer.FirstName, @"^[a-zA-Z-' ]+$"))
            {
                ErrorMessage("[FIRST NAME] - Letters, hyphens, spaces, or apostrophes only");
                return;
            }
            if (string.IsNullOrEmpty(newCustomer.LastName) || !Regex.IsMatch(newCustomer.LastName, @"^[a-zA-Z-' ]+$"))
            {
                ErrorMessage("[LAST NAME] - Letters, hyphens, spaces, or apostrophes only");
                return;
            }

            services.Add(newCustomer);
            newCustomer = new Customer();

            customers = services.Get<IPerson>().ToList();
            errorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task RentVehicleAsync(IVehicle v)
    {
        isProcessing = true;
        try
        {
            await Task.Delay(5000);
            services.RentVehicle(v, selectedCustomer, customers);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            bookings = services.Get<IBooking>().ToList();
            vehicles = services.Get<IVehicle>().ToList();
            selectedCustomer = string.Empty;
        }
    }

    private void ReturnVehicle(IBooking b)
    {
        try
        {
            services.ReturnVehicle(b);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
    }
}
